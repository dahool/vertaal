{% extends "files/file_base.html" %}
{% load i18n extendtags timezone_filters settingstag %}
{% block title %}{{block.super}} | {{ language.name }} -{{ release.name }}- ({{ release.project.name }}){% endblock %}
{% block extra_head %}
{% include "browser_fixes.html" %}
{% ifsetting ENABLE_RSS %}
<link rel="alternate" type="application/rss+xml" title="{% trans "Latest updates" %}" href="{% url language_release_feed release.slug, language.code %}">
{% if user.is_authenticated %}
<link rel="alternate" type="application/rss+xml" title="{% trans "Latest updates for you" %}" href="{% url language_release_feed release.slug, language.code %}?user={{user.username}}">
{% endif %}
{% endifsetting %}
{% iftrue team.can_manage user %}
{% set 'true' as can_manage %}
{% endiftrue %}
{% ifsetting ENABLE_RSS %}
{% if can_manage or perms.teams.can_commit %}
<link rel="alternate" type="application/rss+xml" title="{% trans "Submission queue" %}" href="{% url language_project_queue_feed release.project.slug, language.code %}">
{% endif %}
{% endifsetting %}
<script type="text/javascript" src="{{STATIC_URL}}js/filelist.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.metadata.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.tablesorter.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.cookie.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.json.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.cookiejar.pack.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.tablesorter.cookie.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.aop.min.js"></script>
<!-- 
<link href="{{STATIC_URL}}facebox/facebox.css" media="screen" rel="stylesheet" type="text/css"/>
<script src="{{STATIC_URL}}facebox/facebox.js" type="text/javascript"></script>
<script type="text/javascript">
$.facebox.settings.loadingImage = '{{STATIC_URL}}facebox/loading.gif';
$.facebox.settings.closeImage = '{{STATIC_URL}}facebox/close.gif';
</script>
-->
<script type="text/javascript"><!--
function add_comment(name, url) {
	$("#lock_comment").attr('action', url);
	$("#comment_text").text(interpolate(gettext('Unlocking file %s'), [name]));
	$("#lock_comment").dialog('open');
}
function load_component(url,replace) {
    if (replace==undefined) replace = false;
    $.post(url, function(data) {
        $(data).find('tbody').each(function() {
            if (replace) {
                $("#filestabs").find('tbody').html($(this).html());
            } else {
                $("#filestabs").find('tbody').append($(this).html());
            }
        });
        $("#filestabs").find('table').trigger("update");
    });    
}
function hide_component(name) {
    loading(true);
    $("#filestabs").find('tr[component="'+name+'"]').remove();
    loading(false);
}
function check_filter_button() {
    n = $("#component_list").find('input:checked');
    if (n.length == 1) {
        $(n).button('disable');
    } else {
        $(n).button('enable');
    }    
}
$(document).ready(function(){ 

    $.tablesorter.addParser({ 
        id: 'percentbars', 
        is: function(s) { 
            return false; 
        }, 
        format: function(s) {
            re = s.match(new RegExp(/(\d*%)/g));
            if (re) {
                s = re[0];
            }
            return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g),""));
        }, 
        type: 'numeric' 
    });
    $.tablesorter.addParser({ 
        id: 'sortext', 
        is: function(s) { 
            return false; 
        }, 
        format: function(s) {
            re = s.match(new RegExp(/<sortext>(.+)<\/sortext>/));
            if (re) {
                s = re[1].toLowerCase();    
            } else {
                s = "";
            }
            return s;
        }, 
        type: 'text' 
    });
    
    $("#component_list > input").removeAttr('checked');
    
    {% for id in cfilter %}
    $("#cmp_{{id}}").attr('checked', true);
    {% endfor %}
    
    /*
    var curr_filter = $.cookie("cfilter_{{release.slug}}", {raw: true});
    if (curr_filter != undefined) {
        curr_filter.split(',').forEach(function(el, idx, arr) {
            $("#cmp_" + el).attr('checked', true);
        });
    }
    */
    $("#component_list").buttonset();
    $("#component_list").find('input:checked').button("option", "icons", {primary:'ui-icon-circle-check'});
    $("#component_list").find('input:not(:checked)').button("option", "icons", {primary:'ui-icon-circle-plus'});
    
    $("#component_list").find('input').change(function(){
        var cfilter = [];
        $("#component_list").find('input:checked').each(function() {
            cfilter.push($(this).attr('id').substring(4));
        });
        check_filter_button();
        if (cfilter.length == 0) {
            show_ok_dialog(gettext("You can't hide all components."));
        } else {
            $.cookie("cmpfilter_{{release.slug}}", cfilter.join(), { raw: true, expires: 30, path: '/' });
            if ($(this).is(':checked')) {
                $(this).next().children('.ui-button-icon-primary').addClass("ui-icon-circle-check").removeClass("ui-icon-circle-plus");
                load_component($(this).val());
            } else {
                $(this).next().children('.ui-button-icon-primary').addClass("ui-icon-circle-plus").removeClass("ui-icon-circle-check");
                hide_component($(this).attr('name'));
            }
        }
    });

    check_filter_button();
    
    $("#filestabs").find('table').tablesorter({
        widgets: ['cookie'],
        sortList: [[0,0]],
    });
    
    $("#filestabs").find('table').bind("sortStart",function() { 
        loading(true);
    }).bind("sortEnd",function() { 
        loading(false);
    }); 
        
    jQuery.aop.before({target: jQuery.fn, method: "hide"},
    function(){
        this.trigger("hide");
    });
    
    $(document).keyup(function(event){
        if (event.keyCode == 27) {
            check_current();
        }
    });
    init_select_events();
		
    $("#filterbutton").click(function() {
        $("input[name='extraFunc']").each(function() {
            if ($(this).is(':checked')) {
                $.cookie($(this).attr('alt'), 'true', { expires: 30, path: '/' });
            } else {
                $.cookie($(this).attr('alt'), null, {path: '/' });
            }
        });			
        load_component("{% url reload_list_files release.slug,language.code %}", true);
    });

    $("#comment_input").keyup(function (e) {
        if( e.keyCode == $.ui.keyCode.ENTER ) {
            e.preventDefault();
            $("#lock_comment ~ div.ui-dialog-buttonpane").find('button').click();
        }
    });
		
    $( "#lock_comment" ).dialog({
        autoOpen: false,
        width: 350,
        modal: true,
        resizable: false,
        buttons: {
            '{% trans "Ok" %}': function() {
                var bValid = true;
                bValid = bValid && checkLength( $("#comment_input"), '{% trans "Comments" %}', 4, 255 );
                if ( bValid ) {
                    try_toggle($("#lock_comment").attr('action'),{'text': $('#comment_input').val()});
                    $( this ).dialog( "close" );
                }
            },
        },
        open: function() {
            $(".validateTips").text('');
            $("#comment_input").val('');
        },
        close: function() {
            $("#comment_input").removeClass( "ui-state-error" );
        }
    });
    
    $("#component_list").show();
    $("#filestabs").show();
		
}); 
--></script>
{% endblock %}
{% block quick_menu %}
{{ block.super }}
<span>{{ language.name }}</span>
{% endblock %}
{% block content %}

{% iftrue team.can_manage user %}
{% set 'true' as can_manage %}
{% endiftrue %}

{% block content_title %}<h1>{{ language.name }}&nbsp;<sup>({{ language.code }})</sup>
{% ifsetting ENABLE_RSS %}
&nbsp;&nbsp;<a class="icon feed" title="{% trans "Latest updates" %}" href="{% url language_release_feed release.slug, language.code %}">&nbsp;</a>
{% if user.is_authenticated %}
<a class="icon feed_user" title="{% trans "Latest updates for you" %}" href="{% url language_release_feed release.slug, language.code %}?user={{user.username}}">&nbsp;</a>
{% endif %}
{% endifsetting %}
</h1>{% endblock %}

<div class="details">
	<table class="definition">
		{% if can_manage or perms.teams.can_commit %}		
		<tr>
		<td colspan="2">
		  {% ifsetting ENABLE_RSS %}
			<a class="icon feed soft_text" href="{% url language_project_queue_feed release.project.slug, language.code %}">{% trans "Submission queue" %}</a>
		  {% endifsetting %}
		</td>
		</tr>
		<tr><td colspan="2">&nbsp;</td></tr>
		{% endif %}
		<tr>
			<th class="icon team-page">{% trans "Team:" %}</th>
			<td><a href="{{ team.get_absolute_url }}">{{ language.name }}</a></td>
		</tr>
		<tr>
			<th class="icon project">{% trans "Project:" %}</th>
			<td><a href="{{ release.project.get_absolute_url }}">{{ release.project.name }}</a></td>
		</tr>
		<tr>
			<th class="icon release">{% trans "Release:" %}</th>
			<td><a href="{{ release.get_absolute_url }}">{{ release.name }}</a></td>
		</tr>
	</table>
</div>
{% if release.enabled and release.project.enabled %}
	{% set 'enabled' as enabled %}
{% endif %}
{% if release.read_only or release.project.read_only %}
	{% set 'read_only' as readonly %}
{% endif %}	
{% if user.is_authenticated and enabled and not readonly %}
	{% include "files/upload_box.html" %}
{% endif %}

<br/>

{% if user.is_authenticated and enabled and not readonly %}
<div class="filter-box">
	<fieldset>
		<ul class="simple">
			<li>
			<input name="extraFunc" id="id_hidetranslated" type="checkbox" alt="shide_{{release.slug}}" {% if hideTranslated %}checked{% endif %}>
			<label for="id_hidetranslated">{% trans "Hide fully translated files" %}</label>
			</li>
			<li>
			<input name="extraFunc" id="id_onlySelf" type="checkbox" alt="onlys_{{release.slug}}" {% if onlySelf %}checked{% endif %}>
			<label for="id_onlySelf">{% trans "Show my files only" %}</label>
			</li>
			<li>
			<button id="filterbutton" class="icon submit right">{% trans "Apply" %}</button>
			</li>			
		</ul>
	</fieldset> 
</div>
{% endif %}

<br/>
<div id="component_list" style="display: none;">
{% with release.project.components.all as components %}
	{% for component in components|dictsort:"pk" %}
    <input type="checkbox" id="cmp_{{component.pk}}" name="{{component.slug}}" value="{% url list_files_component release=release.slug language=language.code component=component.slug %}{% if highlight %}?h={{highlight}}{%endif%}"/>
    <label for="cmp_{{component.pk}}">{{ component.name }}</label>
	{% endfor %}
{% endwith %}
</div>

<div id="filestabs" class="ui-widget-content ui-corner-all" style="display: none;">
{% include "files/file_list_table.html" %}
</div>

{% if user.is_authenticated %}
<br/>
<div class="details">
    <h2>{% trans "Recent activity" %}</h2>
    <ul class="simple">
	{% for log in last_actions %}
	{% with log.pofile.filename as filename %}
	{% with log.get_action_display|lower as log_action %}
	{% with log.user.username as username %}
	{% with log.created|localtime:request.user.get_profile.timezone|timesince as updated %}
    {% url file_detail log.pofile.slug as logfileurl %}
	<li class="icon info">{% blocktrans %}File <b><a href="{{logfileurl}}">{{filename}}</a></b> {{log_action}} by <b>{{username}}</b> {{updated}} ago.{% endblocktrans %}</li>
	{% endwith %}{% endwith %}{% endwith %}{% endwith %} 
	{% endfor %}
	</ul>
</div>
{% endif %}
<div id="user-selection-list" class="floating-box">
<select id="user-select" style="width: 150px;">
{% for user in team.team_members %}
	<option value="{{user.id}}">{{user.username}}{%if user.get_full_name%} ({{user.get_full_name}}){%endif%}</option>
{% endfor %}
</select>
<span id="select_ok" onclick="$('#user-selection-list').submit()" class="nodecoration_icon action_icon2 submit link" style="padding-right: 0px;">&nbsp;</span>
<span id="select_nok" onclick="$('#user-selection-list').hide()" class="nodecoration_icon action_icon2 cancel link" style="padding-right: 0px; margin-left: 0px;">&nbsp;</span>
</div>

<div id="lock_comment" style="display: none;">
<fieldset>
	<p class="validateTips help_text"></p>
	<span id="comment_text"></span><br/><br/>
	<label for="comment_input">{% trans "Comments" %}:</label>
	<input id="comment_input" maxlength="255" size="15" type="text" value="" class="text ui-widget-content ui-corner-all">
</fieldset>
</div> 

{% endblock %}
